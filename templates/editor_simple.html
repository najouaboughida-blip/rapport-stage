<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âditeur de Rapport ‚Äî ENSAO</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* ‚îÄ‚îÄ Layout global ‚îÄ‚îÄ */
        body { background: #f0f2f5; margin: 0; }

        .top-bar {
            background: linear-gradient(135deg, #2C3E50, #1A2530);
            color: #fff;
            padding: 14px 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,.25);
        }
        .top-bar h2 { margin: 0; font-size: 1.1rem; font-weight: 600; }
        .top-bar .meta { font-size: .8rem; opacity: .7; }

        .page-wrap {
            display: flex;
            max-width: 1400px;
            margin: 24px auto;
            gap: 20px;
            padding: 0 20px;
        }

        /* ‚îÄ‚îÄ Sidebar : liste des sections ‚îÄ‚îÄ */
        .sidebar {
            width: 260px;
            flex-shrink: 0;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,.08);
            overflow: hidden;
            height: fit-content;
            position: sticky;
            top: 80px;
        }
        .sidebar-header {
            background: #2C3E50;
            color: #fff;
            padding: 12px 16px;
            font-weight: 600;
            font-size: .85rem;
            text-transform: uppercase;
            letter-spacing: .5px;
        }
        .section-item {
            padding: 11px 16px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background .15s;
            font-size: .88rem;
            color: #2C3E50;
        }
        .section-item:last-child { border-bottom: none; }
        .section-item:hover { background: #f0f4f8; }
        .section-item.active {
            background: #3498DB;
            color: #fff;
            font-weight: 600;
        }
        .section-item .dot {
            width: 9px; height: 9px;
            border-radius: 50%;
            background: #BDC3C7;
            flex-shrink: 0;
        }
        .section-item.active .dot { background: #fff; }
        .section-item .saved-badge {
            margin-left: auto;
            font-size: .7rem;
            background: #27AE60;
            color: #fff;
            padding: 2px 7px;
            border-radius: 10px;
            display: none;
        }
        .section-item.saved .saved-badge { display: inline-block; }

        /* ‚îÄ‚îÄ Main : √©diteur ‚îÄ‚îÄ */
        .main-area {
            flex: 1;
            min-width: 0;
        }

        .editor-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,.08);
            overflow: hidden;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 10px 14px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        .toolbar button {
            background: none;
            border: 1px solid transparent;
            border-radius: 6px;
            padding: 5px 9px;
            cursor: pointer;
            font-size: .82rem;
            color: #495057;
            transition: all .15s;
            font-family: inherit;
        }
        .toolbar button:hover { background: #e2e6ea; border-color: #dee2e6; }
        .toolbar button.active { background: #3498DB; color: #fff; border-color: #2980B9; }
        .toolbar .sep {
            width: 1px;
            background: #dee2e6;
            margin: 4px 4px;
        }
        .toolbar select {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: .82rem;
            color: #495057;
            background: #fff;
            cursor: pointer;
        }

        /* Editable area */
        .editor-body {
            padding: 32px 40px;
            min-height: 520px;
            outline: none;
            font-family: 'Times New Roman', serif;
            font-size: 12pt;
            line-height: 1.7;
            color: #2C3E50;
        }
        .editor-body h2 {
            color: #2C3E50;
            border-bottom: 2px solid #3498DB;
            padding-bottom: 6px;
            margin-top: 0;
        }
        .editor-body h3 { color: #2980B9; }
        .editor-body p { text-align: justify; margin-bottom: .7em; }
        .editor-body ul, .editor-body ol { margin-left: 1.6em; margin-bottom: .7em; }

        /* Status bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            font-size: .78rem;
            color: #6c757d;
        }
        .status-bar .save-btn {
            background: #27AE60;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 4px 12px;
            cursor: pointer;
            font-size: .78rem;
            font-weight: 600;
        }
        .status-bar .save-btn:hover { background: #219a52; }

        /* ‚îÄ‚îÄ Download panel (after editing) ‚îÄ‚îÄ */
        .download-panel {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,.08);
            padding: 28px 32px;
            margin-top: 24px;
        }
        .download-panel h3 {
            margin: 0 0 8px;
            color: #2C3E50;
            font-size: 1rem;
        }
        .download-panel p {
            margin: 0 0 18px;
            color: #7F8C8D;
            font-size: .85rem;
        }
        .download-btns {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }
        .dl-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #fff;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 14px 22px;
            cursor: pointer;
            transition: all .2s;
            text-decoration: none;
            color: #2C3E50;
            font-size: .88rem;
            font-weight: 600;
        }
        .dl-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,.12);
        }
        .dl-btn.pdf { border-color: #E74C3C; }
        .dl-btn.pdf:hover { background: #fdf2f2; border-color: #c0392b; }
        .dl-btn.pdf .icon { color: #E74C3C; font-size: 1.4rem; }
        .dl-btn.word { border-color: #3498DB; }
        .dl-btn.word:hover { background: #f0f8ff; border-color: #2980B9; }
        .dl-btn.word .icon { color: #3498DB; font-size: 1.4rem; }

        /* Toast notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 24px;
            z-index: 9999;
            background: #2C3E50;
            color: #fff;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: .82rem;
            box-shadow: 0 4px 12px rgba(0,0,0,.2);
            transform: translateX(140%);
            transition: transform .3s cubic-bezier(.4,0,.2,1);
            max-width: 340px;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { background: #27AE60; }
        .toast.error { background: #E74C3C; }
        .toast.warning { background: #F39C12; }
    </style>
</head>
<body>

<!-- Top Bar -->
<div class="top-bar">
    <div>
        <h2>‚úèÔ∏è √âditeur de Rapport Acad√©mique</h2>
        <span class="meta">{{ report.student.project_title }} ‚Äî {{ report.student.full_name }}</span>
    </div>
    <span class="meta" id="lastSaved">Pas encore sauvegard√©</span>
</div>

<!-- Page wrapper -->
<div class="page-wrap">

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">Sections du rapport</div>
        {% set section_labels = {
            'remerciements': 'üìú Remerciements',
            'resume': 'üìÑ R√©sum√© / Abstract',
            'introduction': 'üìñ Introduction',
            'entreprise': 'üè¢ Entreprise',
            'methodologie': '‚öôÔ∏è M√©thodologie',
            'conclusion': 'üèÅ Conclusion'
        } %}
        {% for key in report.sections %}
        <div class="section-item" data-section="{{ key }}" onclick="switchSection('{{ key }}')">
            {{ section_labels.get(key, key | capitalize) }}
            <span class="saved-badge">‚úì</span>
        </div>
        {% endfor %}
    </aside>

    <!-- Main editor area -->
    <div class="main-area">
        <div class="editor-card">
            <!-- Toolbar -->
            <div class="toolbar">
                <button onclick="fmt('bold')" title="Gras"><b>B</b></button>
                <button onclick="fmt('italic')" title="Italique"><i>I</i></button>
                <button onclick="fmt('underline')" title="Souligner"><u>U</u></button>
                <div class="sep"></div>
                <button onclick="fmt('justifyLeft')" title="Gauche">‚¨õ‚óª‚óª</button>
                <button onclick="fmt('justifyCenter')" title="Centre">‚óª‚¨õ‚óª</button>
                <button onclick="fmt('justifyRight')" title="Droite">‚óª‚óª‚¨õ</button>
                <button onclick="fmt('justifyFull')" title="Justifi√©">‚¨õ‚¨õ‚¨õ</button>
                <div class="sep"></div>
                <button onclick="fmt('insertUnorderedList')" title="Liste puces">‚Ä¢ Liste</button>
                <button onclick="fmt('insertOrderedList')" title="Liste num√©rot√©e">1. Liste</button>
                <div class="sep"></div>
                <select onchange="applyHeading(this.value)" id="headingSelect">
                    <option value="">‚Äî Titre ‚Äî</option>
                    <option value="h2">Titre 1 (H2)</option>
                    <option value="h3">Titre 2 (H3)</option>
                    <option value="h4">Titre 3 (H4)</option>
                </select>
                <div class="sep"></div>
                <button onclick="fmt('removeFormat')" style="color:#E74C3C" title="Effacer formatage">‚úï Format</button>
            </div>

            <!-- Editable zone -->
            <div class="editor-body" id="editorBody" contenteditable="true" spellcheck="true">
                <!-- Content injected by JS -->
            </div>

            <!-- Status bar -->
            <div class="status-bar">
                <span id="wordCount">0 mots</span>
                <button class="save-btn" onclick="saveCurrentSection()">üíæ Sauvegarder cette section</button>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ Download panel (apr√®s l'√©diteur) ‚îÄ‚îÄ -->
        <div class="download-panel">
            <h3>üì• T√©l√©charger votre rapport</h3>
            <p>Modifiez d'abord les sections ci-dessus, puis t√©l√©chargez le rapport complet.</p>
            <div class="download-btns">
                <a href="#" class="dl-btn pdf" id="dlPdf" onclick="downloadPDF(event)">
                    <span class="icon">üìï</span>
                    <div>
                        <div>T√©l√©charger PDF</div>
                        <div style="font-weight:400;font-size:.75rem;color:#999">Format imprimable</div>
                    </div>
                </a>
                <a href="#" class="dl-btn word" id="dlWord" onclick="downloadWord(event)">
                    <span class="icon">üìò</span>
                    <div>
                        <div>T√©l√©charger Word</div>
                        <div style="font-weight:400;font-size:.75rem;color:#999">Format modifiable (.docx)</div>
                    </div>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Configuration
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const REPORT_ID = "{{ report_id }}";
const SECTIONS = {{ report.sections | tojson }};
let currentSection = null;
let isDirty = false;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Init : charger la premi√®re section
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', () => {
    const keys = Object.keys(SECTIONS);
    if (keys.length > 0) {
        switchSection(keys[0]);
    }
    // Compteur de mots en temps r√©el
    document.getElementById('editorBody').addEventListener('input', () => {
        isDirty = true;
        updateWordCount();
    });
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Changer de section
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function switchSection(sectionKey) {
    // Si on change de section et qu'il y a des modifs, sauvegarder d'abord
    if (isDirty && currentSection) {
        await saveCurrentSection();
    }

    currentSection = sectionKey;
    isDirty = false;

    // Mettre √† jour le sidebar
    document.querySelectorAll('.section-item').forEach(el => el.classList.remove('active'));
    const item = document.querySelector(`.section-item[data-section="${sectionKey}"]`);
    if (item) item.classList.add('active');

    // Charger le contenu
    const content = SECTIONS[sectionKey] || '<p><em>Section vide ‚Äî commencez √† √©crire ici.</em></p>';
    document.getElementById('editorBody').innerHTML = content;
    updateWordCount();

    // Reset heading select
    document.getElementById('headingSelect').value = '';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Sauvegarder la section actuelle
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveCurrentSection() {
    if (!currentSection) return;

    const content = document.getElementById('editorBody').innerHTML;
    // Mettre √† jour le cache local
    SECTIONS[currentSection] = content;

    try {
        const res = await fetch(`/api/update-single-section/${REPORT_ID}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ section_name: currentSection, content: content })
        });
        const data = await res.json();

        if (data.success) {
            isDirty = false;
            document.getElementById('lastSaved').textContent = `Sauvegard√© √† ${data.modified_at}`;

            // Marquer comme sauvegard√©e dans le sidebar
            const item = document.querySelector(`.section-item[data-section="${currentSection}"]`);
            if (item) item.classList.add('saved');

            showToast('Section sauvegard√©e ‚úì', 'success');
        } else {
            showToast('Erreur : ' + (data.error || 'inconnue'), 'error');
        }
    } catch (e) {
        showToast('Erreur r√©seau : ' + e.message, 'error');
    }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Formatage texte (toolbar)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmt(command) {
    document.getElementById('editorBody').focus();
    document.execCommand(command, false, null);
    isDirty = true;
}

function applyHeading(level) {
    if (!level) return;
    const sel = window.getSelection();
    if (!sel.toString()) {
        showToast('S√©lectionnez du texte pour appliquer un titre', 'warning');
        document.getElementById('headingSelect').value = '';
        return;
    }
    document.execCommand('formatBlock', false, level);
    isDirty = true;
    document.getElementById('headingSelect').value = '';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Compteur de mots
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateWordCount() {
    const text = document.getElementById('editorBody').innerText || '';
    const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
    document.getElementById('wordCount').textContent = words + ' mot' + (words !== 1 ? 's' : '');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Download PDF
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function downloadPDF(e) {
    e.preventDefault();
    // Sauvegarder d'abord si n√©cessaire
    if (isDirty && currentSection) {
        await saveCurrentSection();
    }
    showToast('G√©n√©ration du PDF en cours‚Ä¶', 'warning');
    // Petit d√©lai pour que le toast soit visible
    setTimeout(() => {
        window.location.href = `/api/download-report-pdf/${REPORT_ID}`;
    }, 600);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Download Word
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function downloadWord(e) {
    e.preventDefault();
    if (isDirty && currentSection) {
        await saveCurrentSection();
    }
    showToast('G√©n√©ration du fichier Word en cours‚Ä¶', 'warning');
    setTimeout(() => {
        window.location.href = `/api/download-report-word/${REPORT_ID}`;
    }, 600);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Toast helper
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let toastTimer = null;
function showToast(msg, type = '') {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.className = 'toast ' + type;
    // Force reflow
    void toast.offsetWidth;
    toast.classList.add('show');

    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.remove('show'), 2800);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Raccourcis clavier
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
        e.preventDefault();
        saveCurrentSection();
    }
});
</script>

</body>
</html>