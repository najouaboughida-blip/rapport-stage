{% extends "base.html" %}

{% block title %}R√©sultats d'Analyse - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
    .analysis-report {
        background: white;
        border-radius: 12px;
        padding: 2.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .score-meter {
        height: 20px;
        background: linear-gradient(90deg, 
            #E74C3C 0%, 
            #F39C12 25%, 
            #F1C40F 50%, 
            #2ECC71 75%, 
            #27AE60 100%);
        border-radius: 10px;
        margin: 1rem 0;
        position: relative;
    }
    
    .score-indicator {
        position: absolute;
        top: -5px;
        width: 30px;
        height: 30px;
        background: white;
        border: 3px solid var(--primary-color);
        border-radius: 50%;
        transform: translateX(-50%);
    }
    
    .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 2rem 0;
    }
    
    .metric-card {
        background: #F8F9FA;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        transition: transform 0.2s;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--primary-color);
        line-height: 1;
        margin-bottom: 0.5rem;
    }
    
    .metric-label {
        font-size: 0.875rem;
        color: var(--text-light);
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .analysis-section {
        margin-bottom: 3rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid #E9ECEF;
    }
    
    .feature-tag {
        display: inline-block;
        background: #E8F4FC;
        color: var(--secondary-color);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        margin: 0.25rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .improvement-card {
        background: linear-gradient(135deg, #FFF3CD 0%, #FFEAA7 100%);
        border: 1px solid #FFEAA7;
        border-radius: 10px;
        padding: 1.5rem;
        margin: 1.5rem 0;
    }
    
    .chart-container {
        height: 300px;
        margin: 2rem 0;
        position: relative;
    }
    
    .next-steps {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 2rem;
        margin-top: 3rem;
    }
    
    .next-steps .btn-light {
        color: var(--primary-color);
        font-weight: 500;
    }
    
    .export-options {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 1rem;
    }
    
    .export-btn {
        flex: 1;
        min-width: 200px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- En-t√™te du rapport -->
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold mb-3" style="color: var(--primary-color);">
                    <i class="fas fa-chart-line me-2"></i>Rapport d'Analyse de Style
                </h1>
                <p class="lead text-muted">
                    Analyse d√©taill√©e de votre style d'√©criture acad√©mique
                </p>
                <div class="d-flex justify-content-center flex-wrap gap-2 mt-3">
                    <span class="badge-academic">
                        <i class="fas fa-calendar me-1"></i>
                        G√©n√©r√© le {{ style_report.timestamp if style_report.timestamp else "Aujourd'hui" }}
                    </span>
                    <span class="badge bg-success">
                        <i class="fas fa-check-circle me-1"></i>
                        Analyse compl√©t√©e
                    </span>
                    {% if style_report.summary %}
                    <span class="badge bg-info">
                        Niveau : {{ style_report.summary.academic_level|default("Acad√©mique") }}
                    </span>
                    {% endif %}
                </div>
            </div>

            <!-- Rapport principal -->
            <div class="analysis-report">
                <!-- R√©sum√© ex√©cutif -->
                <div class="analysis-section">
                    <h3 class="mb-4">
                        <i class="fas fa-clipboard-check me-2"></i>R√©sum√© ex√©cutif
                    </h3>
                    
                    {% if style_report.summary %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="metric-grid">
                                <div class="metric-card">
                                    <div class="metric-value">{{ style_report.summary.formality_score|default(0) }}%</div>
                                    <div class="metric-label">Formalit√©</div>
                                    <div class="score-meter mt-3">
                                        <div class="score-indicator" 
                                             style="left: {{ style_report.summary.formality_score|default(50) }}%;"></div>
                                    </div>
                                    <small class="text-muted">
                                        {{ style_report.summary.formality_level|default("Mod√©r√©") }}
                                    </small>
                                </div>
                                
                                <div class="metric-card">
                                    <div class="metric-value">{{ style_report.summary.complexity|default("Moyenne") }}</div>
                                    <div class="metric-label">Complexit√©</div>
                                    <div class="mt-3">
                                        {% set complexity = style_report.summary.complexity|default("moyenne") %}
                                        {% if complexity == "simple" %}
                                            <i class="fas fa-chart-bar text-success fa-2x"></i>
                                        {% elif complexity == "moyenne" %}
                                            <i class="fas fa-chart-line text-warning fa-2x"></i>
                                        {% else %}
                                            <i class="fas fa-chart-area text-primary fa-2x"></i>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="metric-grid">
                                <div class="metric-card">
                                    <div class="metric-value">{{ style_report.summary.vocabulary|default("Standard") }}</div>
                                    <div class="metric-label">Vocabulaire</div>
                                    <div class="mt-3">
                                        {% set vocab = style_report.summary.vocabulary|default("standard") %}
                                        {% if vocab == "riche" %}
                                            <i class="fas fa-book-open text-success fa-2x"></i>
                                        {% elif vocab == "standard" %}
                                            <i class="fas fa-book text-warning fa-2x"></i>
                                        {% else %}
                                            <i class="fas fa-bookmark text-info fa-2x"></i>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="metric-card">
                                    <div class="metric-value">{{ style_report.summary.technical_terms_count|default(0) }}</div>
                                    <div class="metric-label">Termes techniques</div>
                                    <div class="mt-3">
                                        <i class="fas fa-cogs text-primary fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Les donn√©es d'analyse ne sont pas disponibles. Veuillez r√©essayer.
                    </div>
                    {% endif %}
                </div>

                <!-- Caract√©ristiques d√©taill√©es -->
                {% if style_report.detailed_analysis %}
                <div class="analysis-section">
                    <h3 class="mb-4">
                        <i class="fas fa-search me-2"></i>Caract√©ristiques d√©taill√©es
                    </h3>
                    
                    <div class="row">
                        <!-- Style -->
                        <div class="col-md-6 mb-4">
                            <h5 class="mb-3"><i class="fas fa-pen-nib me-2 text-primary"></i>Style d'√©criture</h5>
                            {% if style_report.detailed_analysis.academic_indicators %}
                            <div class="mb-3">
                                <strong>Indicateurs acad√©miques d√©tect√©s :</strong>
                                <div class="mt-2">
                                    {% for indicator in style_report.detailed_analysis.academic_indicators %}
                                    <span class="feature-tag">{{ indicator }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if style_report.detailed_analysis.structural_patterns %}
                            <div class="mb-3">
                                <strong>Structures textuelles :</strong>
                                <div class="mt-2">
                                    {% for pattern in style_report.detailed_analysis.structural_patterns %}
                                    <span class="feature-tag">{{ pattern }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if style_report.detailed_analysis.transition_words %}
                            <div>
                                <strong>Connecteurs logiques :</strong>
                                <p class="mt-2 mb-0">
                                    {{ style_report.detailed_analysis.transition_words }} connecteurs d√©tect√©s
                                </p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Vocabulaire -->
                        <div class="col-md-6 mb-4">
                            <h5 class="mb-3"><i class="fas fa-book me-2 text-success"></i>Vocabulaire</h5>
                            {% if style_report.detailed_analysis.technical_terms %}
                            <div class="mb-3">
                                <strong>Termes techniques :</strong>
                                <div class="mt-2">
                                    {% for term in style_report.detailed_analysis.technical_terms %}
                                    <span class="feature-tag">{{ term }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if style_report.detailed_analysis.vocabulary_richness %}
                            <div>
                                <strong>Richesse lexicale :</strong>
                                <p class="mt-2 mb-0">
                                    Niveau : <strong>{{ style_report.detailed_analysis.vocabulary_richness }}</strong>
                                </p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Recommandations -->
                {% if style_report.recommendations %}
                <div class="analysis-section">
                    <h3 class="mb-4">
                        <i class="fas fa-lightbulb me-2 text-warning"></i>Recommandations d'am√©lioration
                    </h3>
                    
                    <div class="improvement-card">
                        <h5 class="mb-3">
                            <i class="fas fa-graduation-cap me-2"></i>
                            Suggestions pour optimiser votre style acad√©mique
                        </h5>
                        
                        <ul class="mb-0">
                            {% for rec in style_report.recommendations %}
                            <li class="mb-2">{{ rec.suggestion if rec.suggestion else rec }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    
                    <div class="mt-4">
                        <h6><i class="fas fa-tips me-2 text-info"></i>Conseils pratiques</h6>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="academic-card p-3 h-100">
                                    <h6 class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>√Ä conserver</h6>
                                    <ul class="mb-0">
                                        <li>Votre niveau de formalit√© est appropri√©</li>
                                        <li>Structure des phrases √©quilibr√©e</li>
                                        <li>Vocabulaire adapt√© au domaine</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="academic-card p-3 h-100">
                                    <h6 class="mb-2"><i class="fas fa-exclamation-circle text-warning me-2"></i>√Ä am√©liorer</h6>
                                    <ul class="mb-0">
                                        <li>Varier les structures de phrases</li>
                                        <li>Ajouter des connecteurs logiques</li>
                                        <li>Enrichir le vocabulaire acad√©mique</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Applications -->
                <div class="analysis-section">
                    <h3 class="mb-4">
                        <i class="fas fa-robot me-2 text-primary"></i>Application √† la g√©n√©ration
                    </h3>
                    
                    <div class="alert-academic alert-academic-info mb-4">
                        <h6><i class="fas fa-info-circle me-2"></i>Comment ces donn√©es seront utilis√©es</h6>
                        <p class="mb-0">
                            Votre style d'√©criture analys√© sera utilis√© pour personnaliser la g√©n√©ration IA
                            de votre rapport. Le syst√®me reproduira vos caract√©ristiques stylistiques tout
                            en respectant les normes acad√©miques.
                        </p>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="academic-card p-4 h-100">
                                <h6 class="mb-3"><i class="fas fa-magic me-2 text-success"></i>G√©n√©ration personnalis√©e</h6>
                                <ul class="mb-0">
                                    <li>Reproduction de votre niveau de formalit√©</li>
                                    <li>Adaptation de la longueur des phrases</li>
                                    <li>Utilisation de votre vocabulaire caract√©ristique</li>
                                    <li>Respect de vos structures pr√©f√©r√©es</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="academic-card p-4 h-100">
                                <h6 class="mb-3"><i class="fas fa-file-alt me-2 text-primary"></i>Rapport coh√©rent</h6>
                                <ul class="mb-0">
                                    <li>Style uniforme sur tout le document</li>
                                    <li>Transition fluide entre les sections</li>
                                    <li>Coh√©rence terminologique</li>
                                    <li>Adaptation aux normes ENSA</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- √âtapes suivantes -->
            <div class="next-steps">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h3 class="mb-3">Pr√™t √† g√©n√©rer votre rapport ?</h3>
                        <p class="mb-0" style="opacity: 0.9;">
                            Votre style a √©t√© analys√© avec succ√®s. Passez maintenant √† la g√©n√©ration
                            de votre rapport de stage personnalis√©.
                        </p>
                    </div>
                    <div class="col-lg-4">
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('editor', session_id=session_id) }}" 
                               class="btn btn-light btn-lg">
                                <i class="fas fa-edit me-2"></i>Passer √† l'√©diteur
                            </a>
                            <a href="{{ url_for('start_report') }}" 
                               class="btn btn-outline-light btn-lg">
                                <i class="fas fa-redo me-2"></i>Modifier les informations
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Options d'export -->
            <div class="mt-4">
                <h5 class="mb-3"><i class="fas fa-download me-2"></i>T√©l√©charger l'analyse</h5>
                <div class="export-options">
                    <button class="btn btn-outline-primary export-btn" onclick="exportAsPDF()">
                        <i class="fas fa-file-pdf me-2"></i>PDF
                    </button>
                    <button class="btn btn-outline-success export-btn" onclick="exportAsJSON()">
                        <i class="fas fa-code me-2"></i>JSON
                    </button>
                    <button class="btn btn-outline-info export-btn" onclick="copyToClipboard()">
                        <i class="fas fa-copy me-2"></i>Copier le r√©sum√©
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialiser les graphiques
    initCharts();
    
    // Animation des m√©triques
    animateMetrics();
});

function initCharts() {
    // Graphique de formalit√©
    const ctx = document.createElement('canvas');
    ctx.height = 150;
    $('.chart-container').html(ctx);
    
    // Simple visualisation (pourrait √™tre √©tendue avec Chart.js)
    {% if style_report.summary %}
    const formalityScore = {{ style_report.summary.formality_score|default(50) }};
    const scoreElement = document.createElement('div');
    scoreElement.className = 'score-meter';
    scoreElement.innerHTML = `<div class="score-indicator" style="left: ${formalityScore}%;"></div>`;
    $('.chart-container').html(scoreElement);
    {% endif %}
}

function animateMetrics() {
    $('.metric-value').each(function() {
        const $this = $(this);
        const text = $this.text();
        const isNumber = /^\d+%?$/.test(text.replace('%', ''));
        
        if (isNumber) {
            const value = parseInt(text.replace('%', ''));
            $({ count: 0 }).animate({
                count: value
            }, {
                duration: 1500,
                easing: 'swing',
                step: function() {
                    $this.text(Math.floor(this.count) + (text.includes('%') ? '%' : ''));
                }
            });
        }
    });
}

function exportAsPDF() {
    alert('Export PDF en d√©veloppement. Cette fonctionnalit√© sera disponible prochainement.');
    // En production : appeler une API pour g√©n√©rer un PDF
    // window.open('/api/export-analysis-pdf?session_id={{ session_id }}', '_blank');
}

function exportAsJSON() {
    const analysisData = {{ style_report|tojson|safe }};
    const dataStr = JSON.stringify(analysisData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = 'analyse_style_{{ session_id }}.json';
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
}

function copyToClipboard() {
    const summary = `Rapport d'analyse de style - {{ app_name }}
    
Niveau acad√©mique: {{ style_report.summary.academic_level|default("Non sp√©cifi√©") }}
Score de formalit√©: {{ style_report.summary.formality_score|default(0) }}% ({{ style_report.summary.formality_level|default("Mod√©r√©") }})
Complexit√©: {{ style_report.summary.complexity|default("Moyenne") }}
Vocabulaire: {{ style_report.summary.vocabulary|default("Standard") }}
Termes techniques: {{ style_report.summary.technical_terms_count|default(0) }}

G√©n√©r√© le: {{ style_report.timestamp|default("Aujourd'hui") }}
Session: {{ session_id }}
    
---`;
    
    navigator.clipboard.writeText(summary).then(() => {
        alert('R√©sum√© copi√© dans le presse-papier !');
    });
}

// Sauvegarde automatique
window.addEventListener('beforeunload', function() {
    // Sauvegarder l'ID de session
    localStorage.setItem('lastAnalysisSession', '{{ session_id }}');
});
</script>
{% endblock %}
@app.route('/style-analysis', methods=['POST'])
def analyze_style():
    """Analyse le style d'un texte de r√©f√©rence"""
    try:
        data = request.json
        reference_text = data.get('reference_text', '')
        student_info = data.get('student', {})
        company_info = data.get('company', {})
        
        print(f"üìù Texte de r√©f√©rence (premiers 100 caract√®res): {reference_text[:100]}...")
        print(f"üë§ Info √©tudiant: {student_info}")
        print(f"üè¢ Info entreprise: {company_info}")
        
        # Cr√©er une nouvelle session
        session_id = create_session()
        print(f"‚úÖ Session cr√©√©e: {session_id}")
        
        # Analyser le style
        prompt_generator = AcademicPromptGenerator(reference_text)
        style_report = prompt_generator.get_style_report()
        
        print(f"üìä Rapport de style g√©n√©r√©: {type(style_report)}")
        print(f"üìä Contenu du rapport: {style_report}")
        
        # Stocker les donn√©es
        session_data = {
            'reference_text': reference_text,
            'student_info': student_info,
            'company_info': company_info,
            'style_report': style_report,
            'prompt_generator': prompt_generator  # Note: Cet objet n'est pas JSON-serializable!
        }
        
        update_session_data(session_id, session_data)
        
        return jsonify({
            'success': True,
            'session_id': session_id,
            'style_report': style_report,
            'message': 'Analyse de style compl√©t√©e avec succ√®s'
        })
        
    except Exception as e:
        print(f"‚ùå Erreur analyse style: {e}")
        traceback.print_exc()  # Ajoutez cette ligne pour voir la trace compl√®te
        return jsonify({
            'success': False,
            'error': str(e),
            'traceback': traceback.format_exc()
        }), 500